<div class="flow-layout">
  <!-- LEFT: Node list -->
  <aside class="panel nodes">
    <div class="panel-head">
      <h3>Vozli≈°ƒça</h3>
      <button class="primary" (click)="addNodeAt(flow.nodes.length-1)">+ Dodaj</button>
    </div>

    <ul class="node-list">
      <li *ngFor="let n of flow.nodes; let i = index"
          [class.active]="i===selectedIndex"
          (click)="selectNode(i)">
        <div class="row">
          <div class="id">{{ n.id }}</div>
          <div class="badges">
            <span class="badge" *ngIf="n.openInput">open</span>
            <span class="badge" *ngIf="(n.choices?.length || 0) > 0">
              choices {{ n.choices?.length || 0 }}
            </span>
            <span class="badge" *ngIf="n.action">action</span>
          </div>
        </div>
        <div class="ops" (click)="$event.stopPropagation()">
          <button (click)="moveNode(i,-1)" [disabled]="i===0">‚Üë</button>
          <button (click)="moveNode(i,1)" [disabled]="i===flow.nodes.length-1">‚Üì</button>
          <button (click)="duplicateNode(i)">‚ßâ</button>
          <button class="danger" (click)="deleteNode(i)" [disabled]="flow.nodes.length<=1">üóë</button>
        </div>
      </li>
    </ul>
  </aside>

  <!-- MIDDLE: Node editor -->
  <main class="panel editor" *ngIf="flow.nodes.length">
    <h3>Uredi vozli≈°ƒçe</h3>
    <div class="grid">
      <label>
        <span>ID</span>
        <input type="text" [ngModel]="node().id" (ngModelChange)="onIdChange($event)" />
      </label>

      <label>
        <span>Next (ID ali "done")</span>
        <select [(ngModel)]="node().next">
          <option value="">‚Äî</option>
          <option *ngFor="let id of allNodeIds()" [value]="id">{{ id }}</option>
          <option value="done">done</option>
        </select>
      </label>

      <label class="row">
        <span>Open Input</span>
        <input type="checkbox" [(ngModel)]="node().openInput" (change)="toggleOpenInput()" />
      </label>

      <label *ngIf="node().openInput">
        <span>Input Type</span>
        <select [(ngModel)]="node().inputType">
          <option value="single">single</option>
          <option value="dual">dual</option>
          <option value="dual-contact">dual-contact</option>
        </select>
      </label>

      <label>
        <span>Action</span>
        <select [(ngModel)]="node().action">
          <option value="">‚Äî</option>
          <option value="store_answer">store_answer</option>
          <option value="deepseek_score">deepseek_score</option>
          <option value="show_listings">show_listings</option>
          <option value="deepseek_match">deepseek_match</option>
          <option value="send_brochure">send_brochure</option>
        </select>
      </label>
    </div>

    <div class="texts">
      <div class="head">
        <h4>Besedila</h4>
        <button (click)="addTextLine()">+ Dodaj vrstico</button>
      </div>
      <div class="text-list">
        <div class="text-row" *ngFor="let t of node().texts; let i = index">
          <textarea [(ngModel)]="node().texts![i]" rows="2"></textarea>
          <button class="danger" (click)="removeTextLine(i)" [disabled]="node().texts!.length<=1">üóë</button>
        </div>
      </div>
    </div>

    <div class="choices">
      <div class="head">
        <h4>Izbire</h4>
        <button (click)="addChoice()">+ Dodaj izbiro</button>
      </div>

      <div class="choice" *ngFor="let c of (node().choices || []); let i = index">
        <label>
          <span>Naslov</span>
          <input type="text" [(ngModel)]="c.title" />
        </label>
        <label>
          <span>Next</span>
          <select [(ngModel)]="c.next">
            <option value="">‚Äî</option>
            <option *ngFor="let id of allNodeIds()" [value]="id">{{ id }}</option>
            <option value="done">done</option>
          </select>
        </label>
        <button class="danger" (click)="removeChoice(i)">üóë</button>
      </div>
    </div>

    <div class="payload">
      <h4>Payload (JSON, neobvezno)</h4>
      <textarea
        [ngModel]="payloadToText()"
        (ngModelChange)="onPayloadChange($event)"
        rows="4"
        placeholder='npr. {"images":["vila.png"]}'>
      </textarea>
    </div>
  </main>

  <!-- RIGHT: Validation, import/export -->
  <aside class="panel tools">
    <h3>Veljavnost</h3>
    <div *ngIf="errors.length===0" class="ok">‚úÖ Flow je veljaven</div>
    <ul class="errors" *ngIf="errors.length>0">
      <li *ngFor="let e of errors">‚ö†Ô∏è {{ e }}</li>
    </ul>
    <ul class="info" *ngIf="info.length>0">
      <li *ngFor="let i of info">‚ÑπÔ∏è {{ i }}</li>
    </ul>

    <div class="actions">
      <button (click)="exportJson()">‚¨áÔ∏è Export JSON</button>
      <button (click)="copyJson()">üìã Copy JSON</button>
      <label class="import">
        ‚¨ÜÔ∏è Import JSON
        <input type="file" accept="application/json" (change)="onImportFile($any($event.target).files)" />
      </label>
      <button (click)="saveLocal()">üíæ Save (Local)</button>
      <button class="danger" (click)="resetDefault()">‚Ü∫ Reset</button>
    </div>

    <details class="preview">
      <summary>Pregled JSON</summary>
      <pre>{{ flow | json }}</pre>
    </details>
  </aside>
</div>
