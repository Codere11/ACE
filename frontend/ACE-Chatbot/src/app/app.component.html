<div class="chat-container">
  <div class="messages">
    <div *ngFor="let m of messages" class="msg" [class.user]="m.role==='user'" [class.typing]="m.typing">
      <ng-container *ngIf="!m.typing; else typingTpl">
        {{ m.text }}
      </ng-container>
    </div>
  </div>

  <!-- Quick replies -->
  <div *ngIf="ui && ($any(ui).type === 'choices')" class="choices">
    <button
      *ngFor="let q of $any(ui).buttons"
      class="chip"
      (click)="clickQuickReply(q)"
      [disabled]="loading"
    >
      {{ q.title }}
    </button>
  </div>

  <!-- Mini-survey form -->
  <form *ngIf="isForm(ui)" class="survey card" [formGroup]="surveyForm" (ngSubmit)="submitSurvey()">
    <h4>{{ $any(ui).form.title }}</h4>

    <label class="field">
      <span>{{ $any(ui).form.fields[0].label }}</span>
      <input type="text" formControlName="industry" placeholder="e.g., Dentistry, SaaS, Legal" />
    </label>

    <div class="field">
      <span>{{ $any(ui).form.fields[1].label }}</span>
      <div class="options">
        <label *ngFor="let opt of $any(ui).form.fields[1].options" class="opt">
          <input type="radio" formControlName="budget" [value]="opt.value" />
          {{ opt.label }}
        </label>
      </div>
    </div>

    <label class="field">
      <span>{{ $any(ui).form.fields[2].label }}</span>
      <textarea rows="3" formControlName="experience"
        placeholder="What did you try? How satisfied were you?"></textarea>
    </label>

    <button class="primary" type="submit" [disabled]="loading">Submit</button>
  </form>

  <!-- Composer (gated) -->
  <div class="composer">
    <input
      [disabled]="chatMode!=='open' || loading"
      [(ngModel)]="inputText"
      (keyup.enter)="sendText()"
      placeholder="Type a message..."
      name="composerInput"
    />
    <button (click)="sendText()" [disabled]="chatMode!=='open' || loading">Send</button>
    <small *ngIf="chatMode!=='open'">Quick path: choose an option or fill the mini-survey.</small>
  </div>
</div>

<ng-template #typingTpl>
  <span class="typing-dots">
    <span class="dot"></span><span class="dot"></span><span class="dot"></span>
  </span>
</ng-template>
