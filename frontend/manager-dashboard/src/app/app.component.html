<div class="dashboard-background">
  <div class="dashboard-container">
    <h1 class="title">ğŸ“Š Omsoft ACE Intelligence</h1>
    <p class="subtitle">AI prodajni nadzor za lead gen kampanje</p>

    <!-- Tab Navigation -->
    <nav class="tabs">
      <button [class.active]="activeTab==='leads'" (click)="activeTab='leads'">ğŸ”¥ Leads</button>
      <button [class.active]="activeTab==='notes'" (click)="activeTab='notes'">ğŸ““ Notes/Stages</button>
      <button [class.active]="activeTab==='flow'" (click)="activeTab='flow'">ğŸ“Š Sales Flow</button>
      <button [class.active]="activeTab==='chats'" (click)="activeTab='chats'">ğŸ’¬ Chats</button>
    </nav>

    <!-- TAB 1: Leads -->
    <section *ngIf="activeTab==='leads'">
      <h2>ğŸ”¥ Najbolj kvalificirani kontakti (v Å¾ivo)</h2>

      <div *ngIf="loadingLeads" class="spinner">â³ Nalagam leads...</div>
      <div *ngIf="!loadingLeads && rankedLeads.length === 0" class="empty">
        ğŸš€ Å e ni nobenih leadov â€” poÄakajte na prve pogovore.
      </div>

      <div class="lead-list" *ngIf="!loadingLeads && rankedLeads.length > 0">
        <div *ngFor="let lead of rankedLeads" class="lead-entry">
          <div class="lead-hover-zone"
               (mouseenter)="onLeadHover(lead.id)"
               (mouseleave)="onLeadLeave()">

            <div class="lead-main">
              <div class="lead-top">
                <div class="lead-name">{{ lead.name }} ({{ lead.industry }})</div>
                <div class="lead-score">ğŸ”¥ {{ lead.score }}</div>
              </div>
              <div class="lead-summary">
                Stage: {{ lead.stage }} <span class="dot">â€¢</span>
                {{ formatAgo(lead.lastSeenSec) }}
              </div>
              <div class="lead-lastmsg">â€{{ lead.lastMessage }}â€</div>
              <div class="tags">
                <span class="tag good" *ngIf="lead.compatibility">âœ… Compatibility</span>
                <span class="tag" [class.good]="lead.interest==='High'">â­ {{ lead.interest }}</span>

                <!-- NEW: render actual phone/email text if present, otherwise fall back to badges -->
                <ng-container *ngIf="lead.phoneText?.trim(); else phoneBadge">
                <a class="tag good" [href]="'tel:' + lead.phoneText!.trim()">
                ğŸ“ {{ lead.phoneText }}
                </a>
                </ng-container>
                <ng-template #phoneBadge>
                  <span class="tag" [class.good]="lead.phone">ğŸ“ Phone</span>
                </ng-template>

                <ng-container *ngIf="lead.emailText?.trim(); else emailBadge">
                  <a class="tag good" [href]="'mailto:' + lead.emailText!.trim()">
                  ğŸ“§ {{ lead.emailText }}
                  </a>
                </ng-container>
                <ng-template #emailBadge>
                <span class="tag" [class.good]="lead.email">ğŸ“§ Email</span>
                </ng-template>

                <span class="tag" [class.good]="lead.adsExp">ğŸ“ˆ Ads Exp</span>
              </div>
            </div>

            <!-- chat preview -->
            <div class="chat-preview" *ngIf="hoveredLead === lead.id && leadChats[lead.id]">
              <div *ngFor="let c of leadChats[lead.id]">
                <div [ngClass]="{
                      'user': c.role==='user',
                      'assistant': c.role==='assistant',
                      'staff': c.role==='staff'
                    }">
                  <strong>{{ c.role }}</strong>: {{ c.text }}
                </div>
              </div>
            </div>
          </div>

          <div class="lead-actions">
            <button class="chat-btn" (click)="openTakeover(lead)">Prevzemi pogovor</button>
          </div>
        </div>
      </div>

      <!-- KPIs -->
      <section class="kpis">
        <div *ngIf="loadingKPIs" class="spinner">â³ Nalagam KPI-je...</div>
        <ng-container *ngIf="!loadingKPIs && kpis">
          <div>ğŸ‘¥ Leads: {{ kpis.visitors }}</div>
          <div>ğŸ’¬ Pogovori: {{ kpis.interactions }}</div>
          <div>ğŸ“‡ Kontakti: {{ kpis.contacts }}</div>
          <div>â± Avg. odgovor: {{ kpis.avgResponseSec }}s</div>
          <div>ğŸ”” Aktivni: {{ kpis.activeLeads }}</div>
        </ng-container>
        <div *ngIf="!loadingKPIs && !kpis" class="empty">ğŸš€ Å e ni podatkov o KPI-jih</div>
      </section>
    </section>

    <!-- TAB 2: Notes & Stages -->
    <section *ngIf="activeTab==='notes'">
      <h2>ğŸ““ Notes & Stage Tracking</h2>

      <div class="notes-toolbar" *ngIf="rankedLeads.length > 0; else noLeads">
        <label>
          Lead/Session:
          <select [(ngModel)]="selectedLeadSid" (ngModelChange)="selectLeadSid($event)">
            <option *ngFor="let l of rankedLeads" [ngValue]="l.id">
              {{ l.name }} â€” {{ l.industry }}
            </option>
          </select>
        </label>
        <small class="sid">sid: {{ selectedLeadSid }}</small>
      </div>

      <ng-container *ngIf="selectedLeadSid; else pickOne">
        <ace-notes-table [sid]="selectedLeadSid"></ace-notes-table>
      </ng-container>

      <ng-template #pickOne>
        <div class="empty">Izberite lead zgoraj, da uredite njegove zapiske.</div>
      </ng-template>

      <ng-template #noLeads>
        <div class="empty">ğŸš€ Å e ni leadov, zato ni stage-ov ali notes-ov.</div>
      </ng-template>
    </section>

    <!-- TAB 3: Sales Flow -->
    <section *ngIf="activeTab==='flow'">
      <h2>ğŸ“Š Sales Flow & Heatmaps</h2>

      <div *ngIf="loadingFunnel" class="spinner">â³ Nalagam funnel...</div>
      <section *ngIf="!loadingFunnel && funnel">
        <div class="funnel">
          <div class="funnel-step">Awareness â†’ <span class="bar awareness">{{ funnel.awareness }}%</span></div>
          <div class="funnel-step">Interest â†’ <span class="bar interest">{{ funnel.interest }}%</span></div>
          <div class="funnel-step">Meeting â†’ <span class="bar meeting">{{ funnel.meeting }}%</span></div>
          <div class="funnel-step">Close â†’ <span class="bar close">{{ funnel.close }}%</span></div>
        </div>
      </section>
      <div *ngIf="!loadingFunnel && !funnel" class="empty">ğŸš€ Funnel Å¡e nima podatkov</div>

      <h3>Objections (Ranked)</h3>
      <div *ngIf="loadingObjections" class="spinner">â³ Nalagam objections...</div>
      <ol *ngIf="!loadingObjections && objections.length > 0">
        <li *ngFor="let obj of objections">{{ obj }}</li>
      </ol>
      <div *ngIf="!loadingObjections && objections.length === 0" class="empty">
        ğŸš€ Ni Å¡e nobenih objections
      </div>
    </section>

    <!-- TAB 4: Chats -->
    <section *ngIf="activeTab==='chats'">
      <h2>ğŸ’¬ All Chats</h2>
      <div *ngIf="loadingChats">Loading chats...</div>
      <div *ngIf="!loadingChats && chats.length === 0">No chats yet.</div>
      <div *ngFor="let c of chats">
        <div [ngClass]="{'user': c.role==='user', 'assistant': c.role==='assistant', 'staff': c.role==='staff'}">
          <strong>{{ c.role }}:</strong> {{ c.text }}
          <small>({{ formatAgo(c.timestamp) }})</small>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- Takeover bottom panel -->
<section class="takeover" *ngIf="takeoverOpen && takeoverLead">
  <header class="takeover-header">
    <div class="takeover-title">
      Prevzem pogovora â€” {{ takeoverLead.name }} ({{ takeoverLead.industry }})
      <span class="score">ğŸ”¥ {{ takeoverLead.score }}</span>
    </div>
    <button class="close-btn" (click)="closeTakeover()">Zapri</button>
  </header>

  <div class="takeover-toolbar" *ngIf="takeoverOpen && takeoverLead">
    <label id="pokazi-zgodovino-label">
      <input type="checkbox"
           [checked]="showFullHistoryBySid[takeoverLead.id]"
           (change)="onHistoryToggle($any($event.target).checked)" />
      PokaÅ¾i celotno zgodovino
    </label>
  </div>


  <div id="takeover-body" class="takeover-body">
    <ng-container *ngIf="!takeoverLoading; else taking">
      <div *ngIf="!leadChats[takeoverLead.id] || leadChats[takeoverLead.id].length === 0" class="empty">
        Ni sporoÄil za ta pogovor.
      </div>

      <div *ngFor="let m of getVisibleThread(takeoverLead.id)">
        <div class="bubble" [ngClass]="{'user': m.role==='user', 'assistant': m.role==='assistant', 'staff': m.role==='staff'}">
          <div class="meta">
            <strong>{{ m.role }}</strong>
            <small>{{ formatAgo(m.timestamp) }}</small>
          </div>
          <div class="text">{{ m.text }}</div>
        </div>
      </div>

      <div class="inline-input">
        <input
          type="text"
          placeholder="NapiÅ¡i sporoÄilo kot osebjeâ€¦"
          [(ngModel)]="takeoverInput"
          (keyup.enter)="!takeoverSending && sendStaffMessage()"
          [disabled]="takeoverSending"
        />
        <button class="send-btn" (click)="sendStaffMessage()" [disabled]="takeoverSending || !takeoverInput.trim()">
          {{ takeoverSending ? 'PoÅ¡iljamâ€¦' : 'PoÅ¡lji' }}
        </button>
      </div>
    </ng-container>
    <ng-template #taking>
      <div class="spinner">â³ Nalagam pogovorâ€¦</div>
    </ng-template>
  </div>
</section>
